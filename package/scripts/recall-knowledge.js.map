{"version":3,"file":"recall-knowledge.js","sources":["../src/constants.ts","../src/modules/api.ts","../src/modules/hooks.ts","../src/modules/recall-knowledge-manager.ts","../src/modules/rules-engine.ts","../src/modules/settings.ts","../src/modules/socket.ts","../src/recall-knowledge.ts"],"sourcesContent":["/**\r\n * Module Constants\r\n * Shared constants used throughout the module\r\n */\r\n\r\n// Module identification\r\nexport const MODULE_ID = 'recall-knowledge';\r\nexport const MODULE_TITLE = 'Recall Knowledge';\r\nexport const MODULE_VERSION = '1.0.0';","/**\r\n * Module API for Recall Knowledge\r\n * Provides external API for other modules and macros to interact with\r\n */\r\n\r\nimport { MODULE_ID } from '../constants';\r\nimport { KnowledgeRuleElement, ModifierRuleElement, RuleElement, RulesEngine } from './rules-engine';\r\nimport { RecallKnowledgeSettings } from './settings';\r\nimport { SocketHandler } from './socket';\r\n\r\n/**\r\n * API interface for external access\r\n */\r\nexport interface RecallKnowledgeAPI {\r\n    // Module information\r\n    readonly moduleId: string;\r\n    readonly version: string;\r\n\r\n    // Settings\r\n    settings: {\r\n        get(key: string): unknown;\r\n        set(key: string, value: unknown): Promise<unknown>;\r\n        isRulesEngineEnabled(): boolean;\r\n        isDebugMode(): boolean;\r\n    };\r\n\r\n    // Rules Engine\r\n    rules: {\r\n        addRuleElement(element: RuleElement): void;\r\n        removeRuleElement(key: string): boolean;\r\n        getRuleElement(key: string): RuleElement | undefined;\r\n        getAllRuleElements(): RuleElement[];\r\n        createKnowledgeRule(config: Partial<KnowledgeRuleElement>): KnowledgeRuleElement;\r\n        createModifierRule(config: Partial<ModifierRuleElement>): ModifierRuleElement;\r\n    };\r\n\r\n    // Socket Communication\r\n    socket: {\r\n        shareKnowledgeCheck(actorId: string, checkType: string, result: any): void;\r\n        shareKnowledge(knowledge: any, targetActorId: string, targets?: string[]): void;\r\n        updateRules(ruleElement: any, action: 'add' | 'remove' | 'update'): void;\r\n    };\r\n\r\n    // Knowledge Functions\r\n    knowledge: {\r\n        performCheck(actor: any, checkType: string, options?: any): Promise<any>;\r\n        getKnownInformation(actor: any): any[];\r\n        addKnowledge(actor: any, knowledge: any): void;\r\n        removeKnowledge(actor: any, knowledgeId: string): boolean;\r\n    };\r\n\r\n    // Utility Functions\r\n    utils: {\r\n        isKnowledgeSkill(skill: string): boolean;\r\n        getDCForCreature(creature: any): number;\r\n        formatKnowledgeResult(result: any): string;\r\n    };\r\n}\r\n\r\n/**\r\n * Main Module API class\r\n */\r\nexport class ModuleAPI {\r\n    private rulesEngine?: RulesEngine;\r\n    private socketHandler?: SocketHandler;\r\n    private settings?: RecallKnowledgeSettings;\r\n\r\n    /**\r\n     * Setup the API for external access\r\n     */\r\n    public setupAPI(): void {\r\n        console.log(`${MODULE_ID} | Setting up module API`);\r\n\r\n        // Create the API object\r\n        const api: RecallKnowledgeAPI = {\r\n            moduleId: MODULE_ID,\r\n            version: this.getModuleVersion(),\r\n\r\n            settings: {\r\n                get: (key: string) => this.settings?.getSetting(key),\r\n                set: (key: string, value: unknown) => this.settings?.setSetting(key, value) || Promise.resolve(undefined),\r\n                isRulesEngineEnabled: () => this.settings?.isRulesEngineEnabled() || false,\r\n                isDebugMode: () => this.settings?.isDebugMode() || false\r\n            },\r\n\r\n            rules: {\r\n                addRuleElement: (element: RuleElement) => this.rulesEngine?.addRuleElement(element),\r\n                removeRuleElement: (key: string) => this.rulesEngine?.removeRuleElement(key) || false,\r\n                getRuleElement: (key: string) => this.rulesEngine?.getRuleElement(key),\r\n                getAllRuleElements: () => this.rulesEngine?.getAllRuleElements() || [],\r\n                createKnowledgeRule: (config: Partial<KnowledgeRuleElement>) => this.createKnowledgeRule(config),\r\n                createModifierRule: (config: Partial<ModifierRuleElement>) => this.createModifierRule(config)\r\n            },\r\n\r\n            socket: {\r\n                shareKnowledgeCheck: (actorId: string, checkType: string, result: any) =>\r\n                    this.socketHandler?.shareKnowledgeCheck(actorId, checkType, result),\r\n                shareKnowledge: (knowledge: any, targetActorId: string, targets?: string[]) =>\r\n                    this.socketHandler?.shareKnowledge(knowledge, targetActorId, targets),\r\n                updateRules: (ruleElement: any, action: 'add' | 'remove' | 'update') =>\r\n                    this.socketHandler?.updateRules(ruleElement, action)\r\n            },\r\n\r\n            knowledge: {\r\n                performCheck: (actor: any, checkType: string, options?: any) => this.performKnowledgeCheck(actor, checkType, options),\r\n                getKnownInformation: (actor: any) => this.getKnownInformation(actor),\r\n                addKnowledge: (actor: any, knowledge: any) => this.addKnowledge(actor, knowledge),\r\n                removeKnowledge: (actor: any, knowledgeId: string) => this.removeKnowledge(actor, knowledgeId)\r\n            },\r\n\r\n            utils: {\r\n                isKnowledgeSkill: (skill: string) => this.isKnowledgeSkill(skill),\r\n                getDCForCreature: (creature: any) => this.getDCForCreature(creature),\r\n                formatKnowledgeResult: (result: any) => this.formatKnowledgeResult(result)\r\n            }\r\n        };\r\n\r\n        // Make API globally available\r\n        (globalThis as any).RecallKnowledgeAPI = api;\r\n\r\n        // Also make it available on the game object\r\n        (game as any).RecallKnowledge = api;\r\n\r\n        console.log(`${MODULE_ID} | API registered globally as RecallKnowledgeAPI and game.RecallKnowledge`);\r\n    }\r\n\r\n    /**\r\n     * Set references to other module components\r\n     */\r\n    public setComponents(rulesEngine: RulesEngine, socketHandler: SocketHandler, settings: RecallKnowledgeSettings): void {\r\n        this.rulesEngine = rulesEngine;\r\n        this.socketHandler = socketHandler;\r\n        this.settings = settings;\r\n    }\r\n\r\n    // =============================================================================\r\n    // API Implementation Methods\r\n    // =============================================================================\r\n\r\n    /**\r\n     * Get the module version\r\n     */\r\n    private getModuleVersion(): string {\r\n        const module = game.modules.get(MODULE_ID);\r\n        return module?.version || '1.0.0';\r\n    }\r\n\r\n    /**\r\n     * Create a knowledge rule element with defaults\r\n     */\r\n    private createKnowledgeRule(config: Partial<KnowledgeRuleElement>): KnowledgeRuleElement {\r\n        return {\r\n            key: config.key || 'knowledge.custom',\r\n            label: config.label || 'Custom Knowledge Check',\r\n            selector: config.selector || 'check',\r\n            dc: config.dc || 15,\r\n            type: config.type || 'arcana',\r\n            priority: config.priority || 10,\r\n            success: config.success || 'You recall some information.',\r\n            criticalSuccess: config.criticalSuccess || 'You recall detailed information.',\r\n            failure: config.failure || 'You cannot recall anything useful.',\r\n            criticalFailure: config.criticalFailure || 'You recall false information.',\r\n            ...config\r\n        };\r\n    }\r\n\r\n    /**\r\n     * Create a modifier rule element with defaults\r\n     */\r\n    private createModifierRule(config: Partial<ModifierRuleElement>): ModifierRuleElement {\r\n        return {\r\n            key: config.key || 'modifier.custom',\r\n            label: config.label || 'Custom Modifier',\r\n            selector: config.selector || 'skill-check',\r\n            type: config.type || 'circumstance',\r\n            value: config.value || 0,\r\n            priority: config.priority || 20,\r\n            ...config\r\n        };\r\n    }\r\n\r\n    /**\r\n     * Perform a knowledge check\r\n     */\r\n    private async performKnowledgeCheck(actor: any, checkType: string, options: any = {}): Promise<any> {\r\n        console.log(`${MODULE_ID} | Performing knowledge check: ${checkType} for ${actor.name}`);\r\n\r\n        // Validate inputs\r\n        if (!actor || !checkType) {\r\n            throw new Error('Actor and checkType are required for knowledge checks');\r\n        }\r\n\r\n        // Check if this is a valid knowledge skill\r\n        if (!this.isKnowledgeSkill(checkType)) {\r\n            throw new Error(`${checkType} is not a valid knowledge skill`);\r\n        }\r\n\r\n        // Get the skill modifier\r\n        const skillModifier = this.getSkillModifier(actor, checkType);\r\n\r\n        // Determine DC (could come from options or be calculated)\r\n        const dc = options.dc || this.getDCForCreature(options.target);\r\n\r\n        // Create and evaluate the roll\r\n        const roll = new Roll(`1d20 + ${skillModifier}`);\r\n        await roll.evaluate();\r\n\r\n        // Determine the result\r\n        const total = roll.total || 0;\r\n        const result = this.evaluateKnowledgeResult(total, dc);\r\n\r\n        // Create result object\r\n        const checkResult = {\r\n            actor: actor.id,\r\n            checkType,\r\n            roll,\r\n            total,\r\n            dc,\r\n            result,\r\n            timestamp: Date.now()\r\n        };\r\n\r\n        // Share with other players if enabled\r\n        if (this.settings?.getSetting('shareKnowledge')) {\r\n            this.socketHandler?.shareKnowledgeCheck(actor.id, checkType, checkResult);\r\n        }\r\n\r\n        return checkResult;\r\n    }\r\n\r\n    /**\r\n     * Get known information for an actor\r\n     */\r\n    private getKnownInformation(actor: any): any[] {\r\n        const knowledgeFlag = actor.getFlag(MODULE_ID, 'knownInformation') || [];\r\n        return knowledgeFlag;\r\n    }\r\n\r\n    /**\r\n     * Add knowledge to an actor\r\n     */\r\n    private addKnowledge(actor: any, knowledge: any): void {\r\n        const currentKnowledge = this.getKnownInformation(actor);\r\n        const updatedKnowledge = [...currentKnowledge, { ...knowledge, id: foundry.utils.randomID() }];\r\n        actor.setFlag(MODULE_ID, 'knownInformation', updatedKnowledge);\r\n    }\r\n\r\n    /**\r\n     * Remove knowledge from an actor\r\n     */\r\n    private removeKnowledge(actor: any, knowledgeId: string): boolean {\r\n        const currentKnowledge = this.getKnownInformation(actor);\r\n        const filteredKnowledge = currentKnowledge.filter((k: any) => k.id !== knowledgeId);\r\n\r\n        if (filteredKnowledge.length !== currentKnowledge.length) {\r\n            actor.setFlag(MODULE_ID, 'knownInformation', filteredKnowledge);\r\n            return true;\r\n        }\r\n\r\n        return false;\r\n    }\r\n\r\n    /**\r\n     * Check if a skill is a knowledge skill\r\n     */\r\n    private isKnowledgeSkill(skill: string): boolean {\r\n        const knowledgeSkills = ['arcana', 'nature', 'occultism', 'religion', 'crafting', 'lore'];\r\n        return knowledgeSkills.includes(skill.toLowerCase());\r\n    }\r\n\r\n    /**\r\n     * Get DC for a creature (simplified implementation)\r\n     */\r\n    private getDCForCreature(creature: any): number {\r\n        if (!creature) return 15; // Default DC\r\n\r\n        // Simple DC calculation based on creature level\r\n        const level = creature.system?.level?.value || 0;\r\n        return 10 + level; // Simplified formula\r\n    }\r\n\r\n    /**\r\n     * Format knowledge check result\r\n     */\r\n    private formatKnowledgeResult(result: any): string {\r\n        if (!result) return '';\r\n\r\n        const { checkType, total, dc, result: outcome } = result;\r\n        return `${checkType.charAt(0).toUpperCase() + checkType.slice(1)} Check: ${total} vs DC ${dc} (${outcome})`;\r\n    }\r\n\r\n    /**\r\n     * Get skill modifier for an actor\r\n     */\r\n    private getSkillModifier(actor: any, skill: string): number {\r\n        // This would need to be adapted based on the game system\r\n        // For now, return a placeholder value\r\n        return actor.system?.skills?.[skill]?.mod || 0;\r\n    }\r\n\r\n    /**\r\n     * Evaluate knowledge check result\r\n     */\r\n    private evaluateKnowledgeResult(total: number, dc: number): string {\r\n        const margin = total - dc;\r\n\r\n        if (margin >= 10) return 'criticalSuccess';\r\n        if (margin >= 0) return 'success';\r\n        if (margin >= -10) return 'failure';\r\n        return 'criticalFailure';\r\n    }\r\n}","/**\r\n * Hook Manager for Recall Knowledge Module\r\n * Manages all Foundry VTT hooks used by the module\r\n */\r\n\r\nimport { MODULE_ID } from '../constants';\r\n\r\n/**\r\n * Hook callback function type\r\n */\r\ntype HookCallback = (...args: any[]) => void | Promise<void>;\r\n\r\n/**\r\n * Hook registration interface\r\n */\r\ninterface HookRegistration {\r\n    event: string;\r\n    callback: HookCallback;\r\n    once?: boolean;\r\n}\r\n\r\n/**\r\n * Main Hook Manager class\r\n */\r\nexport class HookManager {\r\n    private registeredHooks: Map<string, HookCallback[]> = new Map();\r\n\r\n    /**\r\n     * Setup all module hooks\r\n     */\r\n    public setupHooks(): void {\r\n        console.log(`${MODULE_ID} | Setting up hooks`);\r\n\r\n        // Core initialization hooks\r\n        this.registerHook('init', this.onInit.bind(this));\r\n        this.registerHook('ready', this.onReady.bind(this));\r\n        this.registerHook('canvasReady', this.onCanvasReady.bind(this));\r\n\r\n        // Actor hooks\r\n        this.registerHook('createActor', this.onCreateActor.bind(this));\r\n        this.registerHook('updateActor', this.onUpdateActor.bind(this));\r\n        this.registerHook('deleteActor', this.onDeleteActor.bind(this));\r\n\r\n        // Item hooks\r\n        this.registerHook('createItem', this.onCreateItem.bind(this));\r\n        this.registerHook('updateItem', this.onUpdateItem.bind(this));\r\n        this.registerHook('deleteItem', this.onDeleteItem.bind(this));\r\n\r\n        // Chat message hooks\r\n        this.registerHook('createChatMessage', this.onCreateChatMessage.bind(this));\r\n        this.registerHook('renderChatMessage', this.onRenderChatMessage.bind(this));\r\n\r\n        // Combat hooks\r\n        this.registerHook('combatStart', this.onCombatStart.bind(this));\r\n        this.registerHook('combatTurn', this.onCombatTurn.bind(this));\r\n        this.registerHook('combatEnd', this.onCombatEnd.bind(this));\r\n\r\n        // Token hooks\r\n        this.registerHook('controlToken', this.onControlToken.bind(this));\r\n        this.registerHook('updateToken', this.onUpdateToken.bind(this));\r\n\r\n        // Dice rolling hooks\r\n        this.registerHook('diceSoNice.diceRolled', this.onDiceRolled.bind(this));\r\n    }\r\n\r\n    /**\r\n     * Register a hook\r\n     */\r\n    public registerHook(event: string, callback: HookCallback, once = false): void {\r\n        if (!this.registeredHooks.has(event)) {\r\n            this.registeredHooks.set(event, []);\r\n        }\r\n\r\n        this.registeredHooks.get(event)!.push(callback);\r\n\r\n        if (once) {\r\n            Hooks.once(event, callback);\r\n        } else {\r\n            Hooks.on(event, callback);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Unregister all hooks for this module\r\n     */\r\n    public unregisterAllHooks(): void {\r\n        for (const [event, callbacks] of this.registeredHooks) {\r\n            callbacks.forEach(callback => {\r\n                // Note: Foundry doesn't have a direct way to unregister hooks\r\n                // This would need custom implementation or module reload\r\n            });\r\n        }\r\n        this.registeredHooks.clear();\r\n    }\r\n\r\n    // =============================================================================\r\n    // Hook Handlers\r\n    // =============================================================================\r\n\r\n    /**\r\n     * Handle init hook\r\n     */\r\n    private onInit(): void {\r\n        console.log(`${MODULE_ID} | Init hook triggered`);\r\n        // Additional initialization logic here\r\n    }\r\n\r\n    /**\r\n     * Handle ready hook\r\n     */\r\n    private onReady(): void {\r\n        console.log(`${MODULE_ID} | Ready hook triggered`);\r\n\r\n        // Setup UI elements if needed\r\n        this.setupUI();\r\n\r\n        // Initialize any ready-dependent features\r\n        this.initializeReadyFeatures();\r\n    }\r\n\r\n    /**\r\n     * Handle canvas ready hook\r\n     */\r\n    private onCanvasReady(canvas: any): void {\r\n        console.log(`${MODULE_ID} | Canvas ready hook triggered`);\r\n        // Setup canvas-related functionality\r\n    }\r\n\r\n    /**\r\n     * Handle actor creation\r\n     */\r\n    private onCreateActor(actor: any, options: any, userId: string): void {\r\n        console.log(`${MODULE_ID} | Actor created: ${actor.name}`);\r\n\r\n        // Apply any default rule elements to new actors\r\n        this.applyDefaultActorRules(actor);\r\n    }\r\n\r\n    /**\r\n     * Handle actor updates\r\n     */\r\n    private onUpdateActor(actor: any, updateData: any, options: any, userId: string): void {\r\n        console.log(`${MODULE_ID} | Actor updated: ${actor.name}`);\r\n\r\n        // Process any rule elements that might be affected by the update\r\n        this.processActorUpdate(actor, updateData);\r\n    }\r\n\r\n    /**\r\n     * Handle actor deletion\r\n     */\r\n    private onDeleteActor(actor: any, options: any, userId: string): void {\r\n        console.log(`${MODULE_ID} | Actor deleted: ${actor.name}`);\r\n\r\n        // Clean up any module-specific data\r\n        this.cleanupActorData(actor);\r\n    }\r\n\r\n    /**\r\n     * Handle item creation\r\n     */\r\n    private onCreateItem(item: any, options: any, userId: string): void {\r\n        console.log(`${MODULE_ID} | Item created: ${item.name}`);\r\n\r\n        // Process any rule elements on the new item\r\n        this.processItemRules(item);\r\n    }\r\n\r\n    /**\r\n     * Handle item updates\r\n     */\r\n    private onUpdateItem(item: any, updateData: any, options: any, userId: string): void {\r\n        console.log(`${MODULE_ID} | Item updated: ${item.name}`);\r\n\r\n        // Reprocess rule elements if necessary\r\n        this.processItemRules(item);\r\n    }\r\n\r\n    /**\r\n     * Handle item deletion\r\n     */\r\n    private onDeleteItem(item: any, options: any, userId: string): void {\r\n        console.log(`${MODULE_ID} | Item deleted: ${item.name}`);\r\n\r\n        // Clean up any item-related rule elements\r\n        this.cleanupItemRules(item);\r\n    }\r\n\r\n    /**\r\n     * Handle chat message creation\r\n     */\r\n    private onCreateChatMessage(message: any, options: any, userId: string): void {\r\n        // Check if this is a knowledge check or related roll\r\n        if (this.isKnowledgeCheck(message)) {\r\n            this.processKnowledgeCheck(message);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Handle chat message rendering\r\n     */\r\n    private onRenderChatMessage(message: any, html: JQuery, data: any): void {\r\n        // Add custom buttons or formatting to relevant messages\r\n        this.enhanceChatMessage(message, html, data);\r\n    }\r\n\r\n    /**\r\n     * Handle combat start\r\n     */\r\n    private onCombatStart(combat: any): void {\r\n        console.log(`${MODULE_ID} | Combat started`);\r\n\r\n        // Initialize combat-related tracking\r\n        this.initializeCombatTracking(combat);\r\n    }\r\n\r\n    /**\r\n     * Handle combat turn\r\n     */\r\n    private onCombatTurn(combat: any, updateData: any, options: any): void {\r\n        console.log(`${MODULE_ID} | Combat turn changed`);\r\n\r\n        // Process turn-based effects\r\n        this.processCombatTurn(combat);\r\n    }\r\n\r\n    /**\r\n     * Handle combat end\r\n     */\r\n    private onCombatEnd(combat: any): void {\r\n        console.log(`${MODULE_ID} | Combat ended`);\r\n\r\n        // Clean up combat-related data\r\n        this.cleanupCombatTracking(combat);\r\n    }\r\n\r\n    /**\r\n     * Handle token control\r\n     */\r\n    private onControlToken(token: any, controlled: boolean): void {\r\n        if (controlled) {\r\n            console.log(`${MODULE_ID} | Token controlled: ${token.name}`);\r\n\r\n            // Show relevant knowledge information for controlled token\r\n            this.displayTokenKnowledge(token);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Handle token updates\r\n     */\r\n    private onUpdateToken(token: any, updateData: any, options: any, userId: string): void {\r\n        // Process any token-related rule elements\r\n        this.processTokenUpdate(token, updateData);\r\n    }\r\n\r\n    /**\r\n     * Handle dice rolls (if Dice So Nice is installed)\r\n     */\r\n    private onDiceRolled(roll: any): void {\r\n        // Process any special dice roll effects\r\n        this.processDiceRoll(roll);\r\n    }\r\n\r\n    // =============================================================================\r\n    // Helper Methods\r\n    // =============================================================================\r\n\r\n    /**\r\n     * Setup UI elements\r\n     */\r\n    private setupUI(): void {\r\n        // Add module-specific UI elements\r\n    }\r\n\r\n    /**\r\n     * Initialize features that require the ready hook\r\n     */\r\n    private initializeReadyFeatures(): void {\r\n        // Features that need game to be fully loaded\r\n    }\r\n\r\n    /**\r\n     * Apply default rule elements to new actors\r\n     */\r\n    private applyDefaultActorRules(actor: any): void {\r\n        // Apply any default knowledge-related rules\r\n    }\r\n\r\n    /**\r\n     * Process actor updates for rule elements\r\n     */\r\n    private processActorUpdate(actor: any, updateData: any): void {\r\n        // Check if update affects any rule elements\r\n    }\r\n\r\n    /**\r\n     * Clean up actor-related data\r\n     */\r\n    private cleanupActorData(actor: any): void {\r\n        // Remove any module-specific flags or data\r\n    }\r\n\r\n    /**\r\n     * Process item rule elements\r\n     */\r\n    private processItemRules(item: any): void {\r\n        // Process any rule elements defined on the item\r\n    }\r\n\r\n    /**\r\n     * Clean up item rule elements\r\n     */\r\n    private cleanupItemRules(item: any): void {\r\n        // Remove any item-related rule elements\r\n    }\r\n\r\n    /**\r\n     * Check if a chat message is a knowledge check\r\n     */\r\n    private isKnowledgeCheck(message: any): boolean {\r\n        // Logic to determine if message is a knowledge check\r\n        return false; // Placeholder\r\n    }\r\n\r\n    /**\r\n     * Process knowledge check results\r\n     */\r\n    private processKnowledgeCheck(message: any): void {\r\n        // Handle knowledge check processing\r\n    }\r\n\r\n    /**\r\n     * Enhance chat messages with module features\r\n     */\r\n    private enhanceChatMessage(message: any, html: JQuery, data: any): void {\r\n        // Add custom buttons or formatting\r\n    }\r\n\r\n    /**\r\n     * Initialize combat tracking\r\n     */\r\n    private initializeCombatTracking(combat: any): void {\r\n        // Setup combat-related tracking\r\n    }\r\n\r\n    /**\r\n     * Process combat turn changes\r\n     */\r\n    private processCombatTurn(combat: any): void {\r\n        // Handle turn-based processing\r\n    }\r\n\r\n    /**\r\n     * Clean up combat tracking\r\n     */\r\n    private cleanupCombatTracking(combat: any): void {\r\n        // Clean up combat-related data\r\n    }\r\n\r\n    /**\r\n     * Display knowledge information for a token\r\n     */\r\n    private displayTokenKnowledge(token: any): void {\r\n        // Show relevant knowledge about the selected token\r\n    }\r\n\r\n    /**\r\n     * Process token updates\r\n     */\r\n    private processTokenUpdate(token: any, updateData: any): void {\r\n        // Handle token-related rule processing\r\n    }\r\n\r\n    /**\r\n     * Process dice rolls\r\n     */\r\n    private processDiceRoll(roll: any): void {\r\n        // Handle special dice roll effects\r\n    }\r\n}","/**\r\n * Recall Knowledge Manager\r\n * Handles the complete recall knowledge workflow including GM approval and information revelation\r\n */\r\n\r\n\r\nexport interface RecallKnowledgeRequest {\r\n    id: string;\r\n    playerId: string;\r\n    playerName: string;\r\n    actorId: string;\r\n    targetId: string;\r\n    targetName: string;\r\n    timestamp: number;\r\n    availableSkills: KnowledgeSkill[];\r\n}\r\n\r\nexport interface KnowledgeSkill {\r\n    key: string;\r\n    name: string;\r\n    modifier: number;\r\n    isLore: boolean;\r\n}\r\n\r\nexport interface RecallKnowledgeResult {\r\n    success: boolean;\r\n    degree: 'criticalFailure' | 'failure' | 'success' | 'criticalSuccess';\r\n    roll: any;\r\n    total: number;\r\n    dc: number;\r\n    skill: KnowledgeSkill;\r\n    availableInfo: CreatureInformation[];\r\n}\r\n\r\nexport interface CreatureInformation {\r\n    category: string;\r\n    label: string;\r\n    value: string;\r\n    requiresSuccess: boolean;\r\n    requiresCriticalSuccess: boolean;\r\n    gmOnly: boolean;\r\n    revealed: boolean;\r\n}\r\n\r\nexport class RecallKnowledgeManager {\r\n    private pendingRequests: Map<string, RecallKnowledgeRequest> = new Map();\r\n\r\n    /**\r\n     * Get unique identifier for a target (token ID if available, otherwise actor ID)\r\n     */\r\n    private getUniqueTargetId(target: any): string {\r\n        // Try to extract token ID from UUID like \"Scene.xxx.Token.yyy\"\r\n        if (target.uuid) {\r\n            const tokenMatch = target.uuid.match(/\\.Token\\.([^.]+)/);\r\n            if (tokenMatch && tokenMatch[1]) {\r\n                return tokenMatch[1];\r\n            }\r\n        }\r\n        \r\n        // Fallback to token ID or actor ID\r\n        return target.id || target.actor?.id || target.uuid || 'unknown';\r\n    }\r\n\r\n    /**\r\n     * Initiate a recall knowledge check from a player\r\n     */\r\n    public async initiateRecallKnowledge(actor: any, target: any): Promise<void> {\r\n        // Validate inputs\r\n        if (!actor || !target) {\r\n            ui.notifications.error(game.i18n.localize('recall-knowledge.errors.noTarget'));\r\n            return;\r\n        }\r\n\r\n        // Check if GM approval is required\r\n        const settings = (game as any).RecallKnowledge?.settings;\r\n        if (settings?.requiresGMApproval() && !game.user.isGM) {\r\n            await this.requestGMApproval(actor, target);\r\n        } else {\r\n            // Direct roll without GM approval\r\n            await this.showSkillSelectionDialog(actor, target);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Request GM approval for recall knowledge\r\n     */\r\n    private async requestGMApproval(actor: any, target: any): Promise<void> {\r\n        const requestId = foundry.utils.randomID();\r\n        const availableSkills = this.getAvailableSkills(actor);\r\n\r\n        const request: RecallKnowledgeRequest = {\r\n            id: requestId,\r\n            playerId: game.user.id,\r\n            playerName: game.user.name,\r\n            actorId: actor.id,\r\n            targetId: target.id,\r\n            targetName: target.name,\r\n            timestamp: Date.now(),\r\n            availableSkills\r\n        };\r\n\r\n        this.pendingRequests.set(requestId, request);\r\n\r\n        // Send request to GM via socket\r\n        const socketHandler = (game as any).RecallKnowledge?.module?.socketHandler;\r\n        if (socketHandler) {\r\n            socketHandler.sendMessage('gmApprovalRequest', request, this.getGMUserIds());\r\n        }\r\n\r\n        ui.notifications.info(`Recall Knowledge request sent to GM for ${target.name}`);\r\n    }\r\n\r\n    /**\r\n     * Show GM approval dialog\r\n     */\r\n    public async showGMApprovalDialog(request: RecallKnowledgeRequest): Promise<void> {\r\n        if (!game.user.isGM) return;\r\n\r\n        const target = game.actors.get(request.targetId);\r\n        if (!target) return;\r\n\r\n        const content = this.generateGMApprovalHTML(request, target);\r\n\r\n        new Dialog({\r\n            title: game.i18n.localize('recall-knowledge.ui.gmApproval.title'),\r\n            content,\r\n            buttons: {\r\n                approve: {\r\n                    icon: '<i class=\"fas fa-check\"></i>',\r\n                    label: game.i18n.localize('recall-knowledge.ui.gmApproval.approve'),\r\n                    callback: (html: any) => this.approveRequest(request, html)\r\n                },\r\n                deny: {\r\n                    icon: '<i class=\"fas fa-times\"></i>',\r\n                    label: game.i18n.localize('recall-knowledge.ui.gmApproval.deny'),\r\n                    callback: () => this.denyRequest(request)\r\n                }\r\n            },\r\n            default: 'approve',\r\n            close: () => this.denyRequest(request)\r\n        }).render(true);\r\n    }\r\n\r\n    /**\r\n     * Approve GM request and initiate roll\r\n     */\r\n    private async approveRequest(request: RecallKnowledgeRequest, html: any): Promise<void> {\r\n        const selectedSkillKey = html.find('[name=\"selectedSkill\"]:checked').val();\r\n        const customDC = parseInt(html.find('[name=\"customDC\"]').val()) || null;\r\n\r\n        const selectedSkill = request.availableSkills.find(s => s.key === selectedSkillKey);\r\n        if (!selectedSkill) return;\r\n\r\n        const actor = game.actors.get(request.actorId);\r\n        const target = game.actors.get(request.targetId);\r\n        if (!actor || !target) return;\r\n\r\n        // Perform the roll  \r\n        const result = await this.performRecallKnowledgeRoll(actor, target, selectedSkill, customDC || undefined);\r\n\r\n        // Send result back to player\r\n        const socketHandler = (game as any).RecallKnowledge?.module?.socketHandler;\r\n        if (socketHandler) {\r\n            socketHandler.sendMessage('recallKnowledgeResult', {\r\n                requestId: request.id,\r\n                result\r\n            }, [request.playerId]);\r\n        }\r\n\r\n        // Show information selection to GM if successful\r\n        if (result.success) {\r\n            await this.showInformationSelectionDialog(target, result, request.playerId);\r\n        }\r\n\r\n        this.pendingRequests.delete(request.id);\r\n    }\r\n\r\n    /**\r\n     * Deny GM request\r\n     */\r\n    private denyRequest(request: RecallKnowledgeRequest): void {\r\n        const socketHandler = (game as any).RecallKnowledge?.module?.socketHandler;\r\n        if (socketHandler) {\r\n            socketHandler.sendMessage('recallKnowledgeDenied', {\r\n                requestId: request.id,\r\n                reason: 'GM denied the request'\r\n            }, [request.playerId]);\r\n        }\r\n\r\n        this.pendingRequests.delete(request.id);\r\n    }\r\n\r\n    /**\r\n     * Show skill selection dialog (for direct rolls)\r\n     */\r\n    private async showSkillSelectionDialog(actor: any, target: any): Promise<void> {\r\n        const availableSkills = this.getAvailableSkills(actor);\r\n\r\n        const content = await renderTemplate('modules/recall-knowledge/templates/skill-selection.hbs', {\r\n            actor,\r\n            target,\r\n            skills: availableSkills\r\n        });\r\n\r\n        new Dialog({\r\n            title: game.i18n.localize('recall-knowledge.ui.knowledgeCheck.title'),\r\n            content,\r\n            buttons: {\r\n                roll: {\r\n                    icon: '<i class=\"fas fa-dice-d20\"></i>',\r\n                    label: game.i18n.localize('recall-knowledge.ui.knowledgeCheck.roll'),\r\n                    callback: (html: any) => this.handleDirectRoll(actor, target, html)\r\n                },\r\n                cancel: {\r\n                    icon: '<i class=\"fas fa-times\"></i>',\r\n                    label: game.i18n.localize('recall-knowledge.ui.knowledgeCheck.cancel'),\r\n                    callback: () => { }\r\n                }\r\n            },\r\n            default: 'roll'\r\n        }).render(true);\r\n    }\r\n\r\n    /**\r\n     * Handle direct roll without GM approval\r\n     */\r\n    private async handleDirectRoll(actor: any, target: any, html: any): Promise<void> {\r\n        const selectedSkillKey = html.find('[name=\"selectedSkill\"]:checked').val();\r\n        const availableSkills = this.getAvailableSkills(actor);\r\n        const selectedSkill = availableSkills.find(s => s.key === selectedSkillKey);\r\n\r\n        if (!selectedSkill) return;\r\n\r\n        const result = await this.performRecallKnowledgeRoll(actor, target, selectedSkill);\r\n\r\n        if (result.success && game.user.isGM) {\r\n            await this.showInformationSelectionDialog(target, result);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Perform the actual recall knowledge roll\r\n     */\r\n    private async performRecallKnowledgeRoll(\r\n        actor: any,\r\n        target: any,\r\n        skill: KnowledgeSkill,\r\n        customDC?: number\r\n    ): Promise<RecallKnowledgeResult> {\r\n        const targetId = this.getUniqueTargetId(target);\r\n        \r\n        // Get or calculate DC\r\n        let dc: number;\r\n        if (customDC !== undefined) {\r\n            // GM provided a custom DC - store it for this token\r\n            dc = customDC;\r\n            const storedDCs = game.user.getFlag('recall-knowledge', 'targetDCs') || {};\r\n            storedDCs[targetId] = dc;\r\n            game.user.setFlag('recall-knowledge', 'targetDCs', storedDCs);\r\n        } else {\r\n            // Use calculateDefaultDC which will check for stored DC or calculate new one\r\n            dc = this.calculateDefaultDC(target);\r\n        }\r\n\r\n        // Create the roll\r\n        const roll = new Roll(`1d20 + ${skill.modifier}`);\r\n        await roll.evaluate();\r\n\r\n        const total = roll.total || 0;\r\n        const margin = total - dc;\r\n\r\n        let degree: 'criticalFailure' | 'failure' | 'success' | 'criticalSuccess';\r\n        if (margin >= 10) degree = 'criticalSuccess';\r\n        else if (margin >= 0) degree = 'success';\r\n        else if (margin >= -10) degree = 'failure';\r\n        else degree = 'criticalFailure';\r\n\r\n        const success = degree === 'success' || degree === 'criticalSuccess';\r\n\r\n        // Create chat message for the roll\r\n        await this.createRollChatMessage(actor, target, skill, roll, dc, degree);\r\n\r\n        // Get available information based on success\r\n        const availableInfo = success ? this.getAvailableInformation(target, degree === 'criticalSuccess') : [];\r\n\r\n        return {\r\n            success,\r\n            degree,\r\n            roll,\r\n            total,\r\n            dc,\r\n            skill,\r\n            availableInfo\r\n        };\r\n    }\r\n\r\n    /**\r\n     * Show information selection dialog to GM\r\n     */\r\n    private async showInformationSelectionDialog(\r\n        target: any,\r\n        result: RecallKnowledgeResult,\r\n        playerId?: string\r\n    ): Promise<void> {\r\n        const content = await renderTemplate('modules/recall-knowledge/templates/information-selection.hbs', {\r\n            target,\r\n            result,\r\n            information: result.availableInfo\r\n        });\r\n\r\n        new Dialog({\r\n            title: game.i18n.localize('recall-knowledge.ui.informationReveal.title'),\r\n            content,\r\n            buttons: {\r\n                revealSelected: {\r\n                    icon: '<i class=\"fas fa-eye\"></i>',\r\n                    label: game.i18n.localize('recall-knowledge.ui.informationReveal.revealSelected'),\r\n                    callback: (html: any) => this.revealSelectedInformation(target, result, html, playerId)\r\n                },\r\n                revealAll: {\r\n                    icon: '<i class=\"fas fa-eye-slash\"></i>',\r\n                    label: game.i18n.localize('recall-knowledge.ui.informationReveal.revealAll'),\r\n                    callback: () => this.revealAllInformation(target, result, playerId)\r\n                },\r\n                cancel: {\r\n                    icon: '<i class=\"fas fa-times\"></i>',\r\n                    label: game.i18n.localize('recall-knowledge.ui.informationReveal.cancel'),\r\n                    callback: () => { }\r\n                }\r\n            },\r\n            default: 'revealSelected'\r\n        }).render(true);\r\n    }\r\n\r\n    /**\r\n     * Reveal selected information to player\r\n     */\r\n    private async revealSelectedInformation(\r\n        target: any,\r\n        result: RecallKnowledgeResult,\r\n        html: any,\r\n        playerId?: string\r\n    ): Promise<void> {\r\n        const selectedInfo = [];\r\n        html.find('[name=\"selectedInfo\"]:checked').each((i: number, el: HTMLElement) => {\r\n            const index = parseInt($(el).val() as string);\r\n            if (result.availableInfo[index]) {\r\n                selectedInfo.push(result.availableInfo[index]);\r\n            }\r\n        });\r\n\r\n        await this.createInformationChatMessage(target, selectedInfo, playerId);\r\n    }\r\n\r\n    /**\r\n     * Reveal all available information to player\r\n     */\r\n    private async revealAllInformation(\r\n        target: any,\r\n        result: RecallKnowledgeResult,\r\n        playerId?: string\r\n    ): Promise<void> {\r\n        await this.createInformationChatMessage(target, result.availableInfo, playerId);\r\n    }\r\n\r\n    /**\r\n     * Get available skills for an actor\r\n     */\r\n    private getAvailableSkills(actor: any): KnowledgeSkill[] {\r\n        const skills: KnowledgeSkill[] = [];\r\n        const settings = (game as any).RecallKnowledge?.settings;\r\n\r\n        // Standard knowledge skills\r\n        const knowledgeSkills = ['arcana', 'nature', 'occultism', 'religion', 'crafting'];\r\n\r\n        for (const skillKey of knowledgeSkills) {\r\n            const skill = actor.system?.skills?.[skillKey];\r\n            if (skill) {\r\n                skills.push({\r\n                    key: skillKey,\r\n                    name: game.i18n.localize(`recall-knowledge.ui.knowledgeCheck.${skillKey}`),\r\n                    modifier: skill.mod || 0,\r\n                    isLore: false\r\n                });\r\n            }\r\n        }\r\n\r\n        // Add lore skills if enabled\r\n        if (settings?.shouldIncludeLoreSkills()) {\r\n            const loreSkills = this.getLoreSkills(actor);\r\n            skills.push(...loreSkills);\r\n        }\r\n\r\n        return skills.sort((a, b) => a.name.localeCompare(b.name));\r\n    }\r\n\r\n    /**\r\n     * Get lore skills for an actor\r\n     */\r\n    private getLoreSkills(actor: any): KnowledgeSkill[] {\r\n        const loreSkills: KnowledgeSkill[] = [];\r\n\r\n        // This would need to be adapted based on the game system\r\n        // For PF2e, lore skills are in actor.system.skills and have 'lore' in their key\r\n        if (actor.system?.skills) {\r\n            for (const [key, skill] of Object.entries(actor.system.skills)) {\r\n                if (key.includes('lore') && (skill as any).mod !== undefined) {\r\n                    loreSkills.push({\r\n                        key,\r\n                        name: (skill as any).name || key,\r\n                        modifier: (skill as any).mod || 0,\r\n                        isLore: true\r\n                    });\r\n                }\r\n            }\r\n        }\r\n\r\n        return loreSkills;\r\n    }\r\n\r\n    /**\r\n     * Calculate default DC for a creature\r\n     */\r\n    private calculateDefaultDC(target: any): number {\r\n        const settings = (game as any).RecallKnowledge?.settings;\r\n\r\n        // Get unique identifier for this specific token\r\n        const targetId = this.getUniqueTargetId(target);\r\n        \r\n        // Check if we already have a DC stored for this specific token\r\n        const storedDCs = game.user.getFlag('recall-knowledge', 'targetDCs') || {};\r\n        if (storedDCs[targetId] !== undefined) {\r\n            return storedDCs[targetId];\r\n        }\r\n\r\n        // Calculate new DC\r\n        let dc = 15; // Default DC\r\n        \r\n        if (settings?.shouldAutoCalculateDC()) {\r\n            const method = settings.getDCCalculationMethod();\r\n            let level = 0;\r\n\r\n            switch (method) {\r\n                case 'level':\r\n                    level = target.system?.level?.value || target.system?.details?.level?.value || 0;\r\n                    break;\r\n                case 'cr':\r\n                    level = target.system?.details?.cr || target.system?.cr || 0;\r\n                    break;\r\n                default:\r\n                    level = 0;\r\n            }\r\n\r\n            // Basic DC calculation: 10 + level\r\n            dc = Math.max(10, 10 + level);\r\n        }\r\n\r\n        // Store DC for this specific token\r\n        storedDCs[targetId] = dc;\r\n        game.user.setFlag('recall-knowledge', 'targetDCs', storedDCs);\r\n\r\n        return dc;\r\n    }\r\n\r\n    /**\r\n     * Get available information about a creature\r\n     */\r\n    private getAvailableInformation(target: any, criticalSuccess: boolean): CreatureInformation[] {\r\n        const settings = (game as any).RecallKnowledge?.settings;\r\n        const revealableInfo = settings?.getRevealableInfo() || {};\r\n        const information: CreatureInformation[] = [];\r\n\r\n        // Basic Information\r\n        if (revealableInfo.basicInfo?.visible) {\r\n            information.push({\r\n                category: 'basic',\r\n                label: 'Name and Type',\r\n                value: `${target.name} (${target.system?.traits?.value?.join(', ') || 'Unknown type'})`,\r\n                requiresSuccess: false,\r\n                requiresCriticalSuccess: false,\r\n                gmOnly: revealableInfo.basicInfo.gmOnly,\r\n                revealed: false\r\n            });\r\n        }\r\n\r\n        // AC Information\r\n        if (revealableInfo.ac?.visible) {\r\n            const ac = target.system?.attributes?.ac?.value || target.system?.ac?.value || 'Unknown';\r\n            information.push({\r\n                category: 'defense',\r\n                label: 'Armor Class',\r\n                value: `AC ${ac}`,\r\n                requiresSuccess: true,\r\n                requiresCriticalSuccess: false,\r\n                gmOnly: revealableInfo.ac.gmOnly,\r\n                revealed: false\r\n            });\r\n        }\r\n\r\n        // Resistances and Immunities\r\n        if (revealableInfo.resistances?.visible) {\r\n            const resistances = this.getResistancesText(target);\r\n            if (resistances) {\r\n                information.push({\r\n                    category: 'defense',\r\n                    label: 'Resistances/Immunities',\r\n                    value: resistances,\r\n                    requiresSuccess: true,\r\n                    requiresCriticalSuccess: false,\r\n                    gmOnly: revealableInfo.resistances.gmOnly,\r\n                    revealed: false\r\n                });\r\n            }\r\n        }\r\n\r\n        // Weaknesses\r\n        if (revealableInfo.weaknesses?.visible) {\r\n            const weaknesses = this.getWeaknessesText(target);\r\n            if (weaknesses) {\r\n                information.push({\r\n                    category: 'defense',\r\n                    label: 'Weaknesses',\r\n                    value: weaknesses,\r\n                    requiresSuccess: true,\r\n                    requiresCriticalSuccess: false,\r\n                    gmOnly: revealableInfo.weaknesses.gmOnly,\r\n                    revealed: false\r\n                });\r\n            }\r\n        }\r\n\r\n        // Saving Throws (Critical Success only)\r\n        if (revealableInfo.saves?.visible && criticalSuccess) {\r\n            const saves = this.getSavesText(target);\r\n            if (saves) {\r\n                information.push({\r\n                    category: 'defense',\r\n                    label: 'Saving Throws',\r\n                    value: saves,\r\n                    requiresSuccess: false,\r\n                    requiresCriticalSuccess: true,\r\n                    gmOnly: revealableInfo.saves.gmOnly,\r\n                    revealed: false\r\n                });\r\n            }\r\n        }\r\n\r\n        return information;\r\n    }\r\n\r\n    /**\r\n     * Get resistances text for a creature\r\n     */\r\n    private getResistancesText(target: any): string {\r\n        // This would need to be adapted based on the game system\r\n        const resistances = target.system?.traits?.dr || target.system?.resistances || [];\r\n        const immunities = target.system?.traits?.di || target.system?.immunities || [];\r\n\r\n        const parts = [];\r\n        if (resistances.length > 0) parts.push(`Resistance: ${resistances.join(', ')}`);\r\n        if (immunities.length > 0) parts.push(`Immunity: ${immunities.join(', ')}`);\r\n\r\n        return parts.join('; ');\r\n    }\r\n\r\n    /**\r\n     * Get weaknesses text for a creature\r\n     */\r\n    private getWeaknessesText(target: any): string {\r\n        // This would need to be adapted based on the game system\r\n        const weaknesses = target.system?.traits?.dv || target.system?.weaknesses || [];\r\n        return weaknesses.length > 0 ? `Weakness: ${weaknesses.join(', ')}` : '';\r\n    }\r\n\r\n    /**\r\n     * Get saving throws text for a creature\r\n     */\r\n    private getSavesText(target: any): string {\r\n        // This would need to be adapted based on the game system\r\n        const saves = target.system?.saves || {};\r\n        const saveTexts = [];\r\n\r\n        for (const [save, data] of Object.entries(saves)) {\r\n            if ((data as any).value !== undefined) {\r\n                saveTexts.push(`${save.toUpperCase()}: +${(data as any).value}`);\r\n            }\r\n        }\r\n\r\n        return saveTexts.join(', ');\r\n    }\r\n\r\n    /**\r\n     * Create chat message for the roll result\r\n     */\r\n    private async createRollChatMessage(\r\n        actor: any,\r\n        target: any,\r\n        skill: KnowledgeSkill,\r\n        roll: any,\r\n        dc: number,\r\n        degree: string\r\n    ): Promise<void> {\r\n        const content = `\r\n      <div class=\"recall-knowledge-roll\">\r\n        <h3>${actor.name} attempts to recall knowledge about ${target.name}</h3>\r\n        <div class=\"roll-details\">\r\n          <p><strong>Skill:</strong> ${skill.name}</p>\r\n          <p><strong>Result:</strong> ${degree}</p>\r\n          <div class=\"dice-roll\">\r\n            ${roll.result} = ${roll.total} vs DC ${dc}\r\n          </div>\r\n        </div>\r\n      </div>\r\n    `;\r\n\r\n        await ChatMessage.create({\r\n            user: game.user.id,\r\n            speaker: ChatMessage.getSpeaker({ actor }),\r\n            content,\r\n            type: CONST.CHAT_MESSAGE_TYPES.ROLL,\r\n            roll,\r\n            sound: CONFIG.sounds.dice\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Create chat message for revealed information\r\n     */\r\n    private async createInformationChatMessage(\r\n        target: any,\r\n        information: CreatureInformation[],\r\n        playerId?: string\r\n    ): Promise<void> {\r\n        if (information.length === 0) return;\r\n\r\n        const content = `\r\n      <div class=\"recall-knowledge-information\">\r\n        <h3>Knowledge about ${target.name}</h3>\r\n        <ul>\r\n          ${information.map(info => `<li><strong>${info.label}:</strong> ${info.value}</li>`).join('')}\r\n        </ul>\r\n      </div>\r\n    `;\r\n\r\n        const messageData: any = {\r\n            user: game.user.id,\r\n            content,\r\n            type: CONST.CHAT_MESSAGE_TYPES.OTHER\r\n        };\r\n\r\n        // Whisper to specific player if specified\r\n        if (playerId) {\r\n            messageData.whisper = [playerId];\r\n        }\r\n\r\n        await ChatMessage.create(messageData);\r\n    }\r\n\r\n    /**\r\n     * Get GM user IDs\r\n     */\r\n    private getGMUserIds(): string[] {\r\n        return game.users.filter((user: any) => user.isGM).map((user: any) => user.id);\r\n    }\r\n\r\n    /**\r\n     * Generate HTML for GM approval dialog\r\n     */\r\n    private generateGMApprovalHTML(request: RecallKnowledgeRequest, target: any): string {\r\n        const skillsHTML = request.availableSkills.map((skill, index) =>\r\n            `<div>\r\n        <input type=\"radio\" name=\"selectedSkill\" value=\"${skill.key}\" id=\"skill-${index}\" ${index === 0 ? 'checked' : ''}>\r\n        <label for=\"skill-${index}\">${skill.name} (+${skill.modifier})</label>\r\n      </div>`\r\n        ).join('');\r\n\r\n        return `\r\n      <div class=\"recall-knowledge-gm-approval\">\r\n        <p><strong>${request.playerName}</strong> wants to recall knowledge about <strong>${target.name}</strong></p>\r\n        \r\n        <div class=\"form-group\">\r\n          <label>Select which skill the player should use:</label>\r\n          <div class=\"skill-selection\">\r\n            ${skillsHTML}\r\n          </div>\r\n        </div>\r\n\r\n        <div class=\"form-group\">\r\n          <label for=\"customDC\">Custom DC (optional):</label>\r\n          <input type=\"number\" name=\"customDC\" id=\"customDC\" value=\"${this.calculateDefaultDC(target)}\" min=\"5\" max=\"50\">\r\n        </div>\r\n      </div>\r\n    `;\r\n    }\r\n\r\n    /**\r\n     * Generate HTML for skill selection dialog\r\n     */\r\n    private generateSkillSelectionHTML(actor: any, target: any, skills: KnowledgeSkill[]): string {\r\n        const skillsHTML = skills.map((skill, index) =>\r\n            `<div>\r\n        <input type=\"radio\" name=\"selectedSkill\" value=\"${skill.key}\" id=\"skill-${index}\" ${index === 0 ? 'checked' : ''}>\r\n        <label for=\"skill-${index}\">${skill.name} (+${skill.modifier})</label>\r\n      </div>`\r\n        ).join('');\r\n\r\n        return `\r\n      <div class=\"recall-knowledge-skill-selection\">\r\n        <p>Select a knowledge skill to use against <strong>${target.name}</strong>:</p>\r\n        \r\n        <div class=\"form-group\">\r\n          <div class=\"skill-selection\">\r\n            ${skillsHTML}\r\n          </div>\r\n        </div>\r\n      </div>\r\n    `;\r\n    }\r\n\r\n    /**\r\n     * Generate HTML for information selection dialog\r\n     */\r\n    private generateInformationSelectionHTML(target: any, result: RecallKnowledgeResult): string {\r\n        const infoHTML = result.availableInfo.map((info, index) =>\r\n            `<div>\r\n        <input type=\"checkbox\" name=\"selectedInfo\" value=\"${index}\" id=\"info-${index}\" checked>\r\n        <label for=\"info-${index}\">\r\n          <strong>${info.label}:</strong> ${info.value}\r\n          ${info.gmOnly ? ' <em>(GM Only)</em>' : ''}\r\n        </label>\r\n      </div>`\r\n        ).join('');\r\n\r\n        return `\r\n      <div class=\"recall-knowledge-info-selection\">\r\n        <p>Choose what to reveal from the <strong>${result.degree}</strong> recall knowledge check:</p>\r\n        \r\n        <div class=\"form-group\">\r\n          <div class=\"info-selection\">\r\n            ${infoHTML}\r\n          </div>\r\n        </div>\r\n      </div>\r\n    `;\r\n    }\r\n}","/**\r\n * Rules Engine for Recall Knowledge Module\r\n * Handles rule element creation, processing, and management\r\n */\r\n\r\nimport { MODULE_ID } from '../constants';\r\n\r\n/**\r\n * Base interface for all rule elements\r\n */\r\nexport interface RuleElement {\r\n    key: string;\r\n    label: string;\r\n    slug?: string;\r\n    priority?: number;\r\n    predicate?: string[];\r\n    ignored?: boolean;\r\n}\r\n\r\n/**\r\n * Knowledge rule element for handling recall knowledge checks\r\n */\r\nexport interface KnowledgeRuleElement extends RuleElement {\r\n    selector: string;\r\n    dc: number | string;\r\n    type: 'arcana' | 'nature' | 'occultism' | 'religion' | 'crafting' | 'lore';\r\n    criticalSuccess?: string;\r\n    success?: string;\r\n    failure?: string;\r\n    criticalFailure?: string;\r\n}\r\n\r\n/**\r\n * Modifier rule element for applying bonuses/penalties\r\n */\r\nexport interface ModifierRuleElement extends RuleElement {\r\n    selector: string;\r\n    type: 'bonus' | 'penalty' | 'circumstance' | 'status' | 'item';\r\n    value: number | string;\r\n    category?: string;\r\n}\r\n\r\n/**\r\n * Main Rules Engine class\r\n */\r\nexport class RulesEngine {\r\n    private ruleElements: Map<string, RuleElement> = new Map();\r\n    private processors: Map<string, (element: RuleElement) => void> = new Map();\r\n\r\n    /**\r\n     * Initialize the rules engine\r\n     */\r\n    public async initialize(): Promise<void> {\r\n        console.log(`${MODULE_ID} | Initializing Rules Engine`);\r\n\r\n        // Register built-in rule processors\r\n        this.registerProcessor('knowledge', this.processKnowledgeRule.bind(this));\r\n        this.registerProcessor('modifier', this.processModifierRule.bind(this));\r\n\r\n        // Setup rule element hooks\r\n        this.setupRuleHooks();\r\n    }\r\n\r\n    /**\r\n     * Register a rule processor\r\n     */\r\n    public registerProcessor(type: string, processor: (element: RuleElement) => void): void {\r\n        this.processors.set(type, processor);\r\n        console.log(`${MODULE_ID} | Registered processor for rule type: ${type}`);\r\n    }\r\n\r\n    /**\r\n     * Add a rule element\r\n     */\r\n    public addRuleElement(element: RuleElement): void {\r\n        this.ruleElements.set(element.key, element);\r\n        this.processRuleElement(element);\r\n    }\r\n\r\n    /**\r\n     * Remove a rule element\r\n     */\r\n    public removeRuleElement(key: string): boolean {\r\n        return this.ruleElements.delete(key);\r\n    }\r\n\r\n    /**\r\n     * Get a rule element by key\r\n     */\r\n    public getRuleElement(key: string): RuleElement | undefined {\r\n        return this.ruleElements.get(key);\r\n    }\r\n\r\n    /**\r\n     * Get all rule elements\r\n     */\r\n    public getAllRuleElements(): RuleElement[] {\r\n        return Array.from(this.ruleElements.values());\r\n    }\r\n\r\n    /**\r\n     * Process a rule element based on its type\r\n     */\r\n    private processRuleElement(element: RuleElement): void {\r\n        const processor = this.processors.get(element.key.split('.')[0]);\r\n        if (processor) {\r\n            processor(element);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Process knowledge rule elements\r\n     */\r\n    private processKnowledgeRule(element: RuleElement): void {\r\n        const knowledgeRule = element as KnowledgeRuleElement;\r\n        console.log(`${MODULE_ID} | Processing knowledge rule: ${knowledgeRule.label}`);\r\n\r\n        // Add knowledge check functionality\r\n        // This would integrate with the chat system and dice rolling\r\n    }\r\n\r\n    /**\r\n     * Process modifier rule elements\r\n     */\r\n    private processModifierRule(element: RuleElement): void {\r\n        const modifierRule = element as ModifierRuleElement;\r\n        console.log(`${MODULE_ID} | Processing modifier rule: ${modifierRule.label}`);\r\n\r\n        // Add modifier to the appropriate system\r\n        // This would integrate with the actor data structure\r\n    }\r\n\r\n    /**\r\n     * Setup hooks for rule processing\r\n     */\r\n    private setupRuleHooks(): void {\r\n        // Hook into actor preparation to apply rule elements\r\n        Hooks.on('preUpdateActor', (actor: any, updateData: any) => {\r\n            this.processActorRules(actor, updateData);\r\n        });\r\n\r\n        // Hook into item preparation to apply rule elements\r\n        Hooks.on('preUpdateItem', (item: any, updateData: any) => {\r\n            this.processItemRules(item, updateData);\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Process rules for actor updates\r\n     */\r\n    private processActorRules(actor: any, updateData: any): void {\r\n        const actorRules = this.getRulesForActor(actor);\r\n        actorRules.forEach(rule => this.processRuleElement(rule));\r\n    }\r\n\r\n    /**\r\n     * Process rules for item updates\r\n     */\r\n    private processItemRules(item: any, updateData: any): void {\r\n        const itemRules = this.getRulesForItem(item);\r\n        itemRules.forEach(rule => this.processRuleElement(rule));\r\n    }\r\n\r\n    /**\r\n     * Get rule elements that apply to a specific actor\r\n     */\r\n    private getRulesForActor(actor: any): RuleElement[] {\r\n        return this.getAllRuleElements().filter(rule => {\r\n            // Check predicates and selectors to see if rule applies to this actor\r\n            return this.evaluatePredicate(rule.predicate, actor);\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Get rule elements that apply to a specific item\r\n     */\r\n    private getRulesForItem(item: any): RuleElement[] {\r\n        return this.getAllRuleElements().filter(rule => {\r\n            // Check predicates and selectors to see if rule applies to this item\r\n            return this.evaluatePredicate(rule.predicate, item);\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Evaluate a predicate against a given context\r\n     */\r\n    private evaluatePredicate(predicate: string[] | undefined, context: any): boolean {\r\n        if (!predicate || predicate.length === 0) {\r\n            return true; // No predicate means rule always applies\r\n        }\r\n\r\n        // Simple predicate evaluation\r\n        // In a full implementation, this would be more sophisticated\r\n        return predicate.every(condition => {\r\n            // Parse condition and evaluate against context\r\n            return true; // Simplified for example\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Create a sample knowledge rule element\r\n     */\r\n    public createSampleKnowledgeRule(): KnowledgeRuleElement {\r\n        return {\r\n            key: 'knowledge.sample',\r\n            label: 'Sample Knowledge Check',\r\n            selector: 'check',\r\n            dc: 15,\r\n            type: 'arcana',\r\n            priority: 10,\r\n            success: 'You recall basic information about this creature.',\r\n            criticalSuccess: 'You recall detailed information about this creature\\'s abilities and weaknesses.',\r\n            failure: 'You cannot recall anything useful about this creature.',\r\n            criticalFailure: 'You recall false information about this creature.'\r\n        };\r\n    }\r\n\r\n    /**\r\n     * Create a sample modifier rule element\r\n     */\r\n    public createSampleModifierRule(): ModifierRuleElement {\r\n        return {\r\n            key: 'modifier.sample',\r\n            label: 'Sample Knowledge Bonus',\r\n            selector: 'skill-check',\r\n            type: 'circumstance',\r\n            value: 2,\r\n            priority: 20,\r\n            predicate: ['action:recall-knowledge']\r\n        };\r\n    }\r\n}","/**\r\n * Module Settings Management\r\n * Handles all configuration settings for the Recall Knowledge module\r\n */\r\n\r\nimport { MODULE_ID } from '../constants';\r\n\r\nexport class RecallKnowledgeSettings {\r\n\r\n    /**\r\n     * Register all module settings\r\n     */\r\n    public async register(): Promise<void> {\r\n        console.log(`${MODULE_ID} | Registering module settings`);\r\n\r\n        // Enable/Disable Rules Engine\r\n        game.settings.register(MODULE_ID, 'enableRulesEngine', {\r\n            name: 'recall-knowledge.settings.enableRulesEngine.name',\r\n            hint: 'recall-knowledge.settings.enableRulesEngine.hint',\r\n            scope: 'world',\r\n            config: true,\r\n            type: Boolean,\r\n            default: true,\r\n            requiresReload: true\r\n        });\r\n\r\n        // Rules Engine Debug Mode\r\n        game.settings.register(MODULE_ID, 'debugMode', {\r\n            name: 'recall-knowledge.settings.debugMode.name',\r\n            hint: 'recall-knowledge.settings.debugMode.hint',\r\n            scope: 'world',\r\n            config: true,\r\n            type: Boolean,\r\n            default: false\r\n        });\r\n\r\n        // Knowledge Check Auto-Roll\r\n        game.settings.register(MODULE_ID, 'autoRollKnowledge', {\r\n            name: 'recall-knowledge.settings.autoRollKnowledge.name',\r\n            hint: 'recall-knowledge.settings.autoRollKnowledge.hint',\r\n            scope: 'world',\r\n            config: true,\r\n            type: Boolean,\r\n            default: false\r\n        });\r\n\r\n        // Maximum Knowledge Attempts\r\n        game.settings.register(MODULE_ID, 'maxKnowledgeAttempts', {\r\n            name: 'recall-knowledge.settings.maxKnowledgeAttempts.name',\r\n            hint: 'recall-knowledge.settings.maxKnowledgeAttempts.hint',\r\n            scope: 'world',\r\n            config: true,\r\n            type: Number,\r\n            default: 1,\r\n            range: {\r\n                min: 1,\r\n                max: 10,\r\n                step: 1\r\n            }\r\n        });\r\n\r\n        // Chat Output Style\r\n        game.settings.register(MODULE_ID, 'chatOutputStyle', {\r\n            name: 'recall-knowledge.settings.chatOutputStyle.name',\r\n            hint: 'recall-knowledge.settings.chatOutputStyle.hint',\r\n            scope: 'world',\r\n            config: true,\r\n            type: String,\r\n            default: 'detailed',\r\n            choices: {\r\n                'simple': 'recall-knowledge.settings.chatOutputStyle.simple',\r\n                'detailed': 'recall-knowledge.settings.chatOutputStyle.detailed',\r\n                'whisper': 'recall-knowledge.settings.chatOutputStyle.whisper'\r\n            }\r\n        });\r\n\r\n        // GM Approval Required\r\n        game.settings.register(MODULE_ID, 'requireGMApproval', {\r\n            name: 'recall-knowledge.settings.requireGMApproval.name',\r\n            hint: 'recall-knowledge.settings.requireGMApproval.hint',\r\n            scope: 'world',\r\n            config: true,\r\n            type: Boolean,\r\n            default: true\r\n        });\r\n\r\n        // Creature Information Settings\r\n        game.settings.register(MODULE_ID, 'revealableInfo', {\r\n            name: 'recall-knowledge.settings.revealableInfo.name',\r\n            hint: 'recall-knowledge.settings.revealableInfo.hint',\r\n            scope: 'world',\r\n            config: true,\r\n            type: Object,\r\n            default: {\r\n                basicInfo: { visible: true, gmOnly: false }, // Name, type, size\r\n                abilities: { visible: true, gmOnly: false }, // Abilities and scores\r\n                skills: { visible: true, gmOnly: true }, // Skill bonuses\r\n                saves: { visible: true, gmOnly: false }, // Saving throws\r\n                ac: { visible: true, gmOnly: false }, // Armor class\r\n                hp: { visible: false, gmOnly: true }, // Hit points\r\n                resistances: { visible: true, gmOnly: false }, // Resistances/immunities\r\n                weaknesses: { visible: true, gmOnly: false }, // Weaknesses\r\n                attacks: { visible: true, gmOnly: true }, // Attack bonuses\r\n                spells: { visible: true, gmOnly: true }, // Spell information\r\n                traits: { visible: true, gmOnly: false }, // Creature traits\r\n                lore: { visible: true, gmOnly: false } // Lore and background\r\n            }\r\n        });\r\n\r\n        // Auto-calculate DC\r\n        game.settings.register(MODULE_ID, 'autoCalculateDC', {\r\n            name: 'recall-knowledge.settings.autoCalculateDC.name',\r\n            hint: 'recall-knowledge.settings.autoCalculateDC.hint',\r\n            scope: 'world',\r\n            config: true,\r\n            type: Boolean,\r\n            default: true\r\n        });\r\n\r\n        // DC Calculation Method\r\n        game.settings.register(MODULE_ID, 'dcCalculationMethod', {\r\n            name: 'recall-knowledge.settings.dcCalculationMethod.name',\r\n            hint: 'recall-knowledge.settings.dcCalculationMethod.hint',\r\n            scope: 'world',\r\n            config: true,\r\n            type: String,\r\n            default: 'level',\r\n            choices: {\r\n                'level': 'recall-knowledge.settings.dcCalculationMethod.level',\r\n                'cr': 'recall-knowledge.settings.dcCalculationMethod.cr',\r\n                'custom': 'recall-knowledge.settings.dcCalculationMethod.custom'\r\n            }\r\n        });\r\n\r\n        // Include Lore Skills\r\n        game.settings.register(MODULE_ID, 'includeLoreSkills', {\r\n            name: 'recall-knowledge.settings.includeLoreSkills.name',\r\n            hint: 'recall-knowledge.settings.includeLoreSkills.hint',\r\n            scope: 'world',\r\n            config: true,\r\n            type: Boolean,\r\n            default: true\r\n        });\r\n    }    /**\r\n     * Get a setting value\r\n     */\r\n    public getSetting(key: string): unknown {\r\n        return game.settings.get(MODULE_ID, key);\r\n    }\r\n\r\n    /**\r\n     * Set a setting value\r\n     */\r\n    public async setSetting(key: string, value: unknown): Promise<unknown> {\r\n        return game.settings.set(MODULE_ID, key, value);\r\n    }\r\n\r\n    /**\r\n     * Check if rules engine is enabled\r\n     */\r\n    public isRulesEngineEnabled(): boolean {\r\n        return this.getSetting('enableRulesEngine') as boolean;\r\n    }\r\n\r\n    /**\r\n     * Check if debug mode is enabled\r\n     */\r\n    public isDebugMode(): boolean {\r\n        return this.getSetting('debugMode') as boolean;\r\n    }\r\n\r\n    /**\r\n     * Check if GM approval is required for recall knowledge checks\r\n     */\r\n    public requiresGMApproval(): boolean {\r\n        return this.getSetting('requireGMApproval') as boolean;\r\n    }\r\n\r\n    /**\r\n     * Get revealable information settings\r\n     */\r\n    public getRevealableInfo(): any {\r\n        return this.getSetting('revealableInfo') as any;\r\n    }\r\n\r\n    /**\r\n     * Check if DC should be auto-calculated\r\n     */\r\n    public shouldAutoCalculateDC(): boolean {\r\n        return this.getSetting('autoCalculateDC') as boolean;\r\n    }\r\n\r\n    /**\r\n     * Get DC calculation method\r\n     */\r\n    public getDCCalculationMethod(): string {\r\n        return this.getSetting('dcCalculationMethod') as string;\r\n    }\r\n\r\n    /**\r\n     * Check if lore skills should be included\r\n     */\r\n    public shouldIncludeLoreSkills(): boolean {\r\n        return this.getSetting('includeLoreSkills') as boolean;\r\n    }\r\n}","/**\r\n * Socket Handler for Recall Knowledge Module\r\n * Manages socket communications for multiplayer functionality\r\n */\r\n\r\nimport { MODULE_ID } from '../constants';\r\n\r\n/**\r\n * Socket message interface\r\n */\r\nexport interface SocketMessage {\r\n    type: string;\r\n    data: any;\r\n    sender: string;\r\n    timestamp: number;\r\n}\r\n\r\n/**\r\n * Socket message types\r\n */\r\nexport enum SocketMessageType {\r\n    KNOWLEDGE_CHECK = 'knowledgeCheck',\r\n    SHARE_KNOWLEDGE = 'shareKnowledge',\r\n    UPDATE_RULES = 'updateRules',\r\n    SYNC_DATA = 'syncData',\r\n    GM_APPROVAL_REQUEST = 'gmApprovalRequest',\r\n    RECALL_KNOWLEDGE_RESULT = 'recallKnowledgeResult',\r\n    RECALL_KNOWLEDGE_DENIED = 'recallKnowledgeDenied'\r\n}/**\r\n * Main Socket Handler class\r\n */\r\nexport class SocketHandler {\r\n    private socketName: string;\r\n    private messageHandlers: Map<string, (message: SocketMessage) => void> = new Map();\r\n\r\n    constructor() {\r\n        this.socketName = `module.${MODULE_ID}`;\r\n    }\r\n\r\n    /**\r\n     * Initialize socket handling\r\n     */\r\n    public initialize(): void {\r\n        console.log(`${MODULE_ID} | Initializing socket handler`);\r\n\r\n        // Register socket\r\n        game.socket.on(this.socketName, (message: SocketMessage) => {\r\n            this.handleSocketMessage(message);\r\n        });\r\n\r\n        // Register message handlers\r\n        this.registerHandlers();\r\n    }\r\n\r\n    /**\r\n     * Register message handlers\r\n     */\r\n    private registerHandlers(): void {\r\n        this.messageHandlers.set(SocketMessageType.KNOWLEDGE_CHECK, this.handleKnowledgeCheck.bind(this));\r\n        this.messageHandlers.set(SocketMessageType.SHARE_KNOWLEDGE, this.handleShareKnowledge.bind(this));\r\n        this.messageHandlers.set(SocketMessageType.UPDATE_RULES, this.handleUpdateRules.bind(this));\r\n        this.messageHandlers.set(SocketMessageType.SYNC_DATA, this.handleSyncData.bind(this));\r\n        this.messageHandlers.set(SocketMessageType.GM_APPROVAL_REQUEST, this.handleGMApprovalRequest.bind(this));\r\n        this.messageHandlers.set(SocketMessageType.RECALL_KNOWLEDGE_RESULT, this.handleRecallKnowledgeResult.bind(this));\r\n        this.messageHandlers.set(SocketMessageType.RECALL_KNOWLEDGE_DENIED, this.handleRecallKnowledgeDenied.bind(this));\r\n    }\r\n\r\n    /**\r\n     * Send a socket message\r\n     */\r\n    public sendMessage(type: string, data: any, targets?: string[]): void {\r\n        const message: SocketMessage = {\r\n            type,\r\n            data,\r\n            sender: game.user.id,\r\n            timestamp: Date.now()\r\n        };\r\n\r\n        if (targets && targets.length > 0) {\r\n            // Send to specific users\r\n            targets.forEach(userId => {\r\n                game.socket.emit(this.socketName, message, userId);\r\n            });\r\n        } else {\r\n            // Broadcast to all users\r\n            game.socket.emit(this.socketName, message);\r\n        }\r\n\r\n        console.log(`${MODULE_ID} | Sent socket message: ${type}`, data);\r\n    }\r\n\r\n    /**\r\n     * Handle incoming socket messages\r\n     */\r\n    private handleSocketMessage(message: SocketMessage): void {\r\n        console.log(`${MODULE_ID} | Received socket message: ${message.type}`, message);\r\n\r\n        // Don't process our own messages\r\n        if (message.sender === game.user.id) {\r\n            return;\r\n        }\r\n\r\n        const handler = this.messageHandlers.get(message.type);\r\n        if (handler) {\r\n            handler(message);\r\n        } else {\r\n            console.warn(`${MODULE_ID} | No handler registered for message type: ${message.type}`);\r\n        }\r\n    }\r\n\r\n    // =============================================================================\r\n    // Message Handlers\r\n    // =============================================================================\r\n\r\n    /**\r\n     * Handle knowledge check messages\r\n     */\r\n    private handleKnowledgeCheck(message: SocketMessage): void {\r\n        const { actorId, checkType, result } = message.data;\r\n\r\n        console.log(`${MODULE_ID} | Processing knowledge check from ${message.sender}`);\r\n\r\n        // Process the knowledge check result\r\n        this.processRemoteKnowledgeCheck(actorId, checkType, result);\r\n    }\r\n\r\n    /**\r\n     * Handle share knowledge messages\r\n     */\r\n    private handleShareKnowledge(message: SocketMessage): void {\r\n        const { knowledge, targetActorId } = message.data;\r\n\r\n        console.log(`${MODULE_ID} | Received shared knowledge from ${message.sender}`);\r\n\r\n        // Display the shared knowledge to the user\r\n        this.displaySharedKnowledge(knowledge, targetActorId);\r\n    }\r\n\r\n    /**\r\n     * Handle rule update messages\r\n     */\r\n    private handleUpdateRules(message: SocketMessage): void {\r\n        const { ruleElement, action } = message.data;\r\n\r\n        console.log(`${MODULE_ID} | Received rule update from ${message.sender}`);\r\n\r\n        // Update local rules based on the message\r\n        this.updateLocalRules(ruleElement, action);\r\n    }\r\n\r\n    /**\r\n     * Handle sync data messages\r\n     */\r\n    private handleSyncData(message: SocketMessage): void {\r\n        const { dataType, syncData } = message.data;\r\n\r\n        console.log(`${MODULE_ID} | Received sync data from ${message.sender}`);\r\n\r\n        // Synchronize local data with the received data\r\n        this.synchronizeData(dataType, syncData);\r\n    }\r\n\r\n    // =============================================================================\r\n    // Utility Methods\r\n    // =============================================================================\r\n\r\n    /**\r\n     * Send a knowledge check result to other players\r\n     */\r\n    public shareKnowledgeCheck(actorId: string, checkType: string, result: any): void {\r\n        this.sendMessage(SocketMessageType.KNOWLEDGE_CHECK, {\r\n            actorId,\r\n            checkType,\r\n            result\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Share knowledge information with specific players\r\n     */\r\n    public shareKnowledge(knowledge: any, targetActorId: string, targets?: string[]): void {\r\n        this.sendMessage(SocketMessageType.SHARE_KNOWLEDGE, {\r\n            knowledge,\r\n            targetActorId\r\n        }, targets);\r\n    }\r\n\r\n    /**\r\n     * Broadcast rule element updates\r\n     */\r\n    public updateRules(ruleElement: any, action: 'add' | 'remove' | 'update'): void {\r\n        // Only GM should broadcast rule updates\r\n        if (!game.user.isGM) {\r\n            return;\r\n        }\r\n\r\n        this.sendMessage(SocketMessageType.UPDATE_RULES, {\r\n            ruleElement,\r\n            action\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Request data synchronization\r\n     */\r\n    public requestSync(dataType: string): void {\r\n        this.sendMessage(SocketMessageType.SYNC_DATA, {\r\n            dataType,\r\n            request: true\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Send synchronization data\r\n     */\r\n    public sendSyncData(dataType: string, syncData: any, targets?: string[]): void {\r\n        this.sendMessage(SocketMessageType.SYNC_DATA, {\r\n            dataType,\r\n            syncData,\r\n            request: false\r\n        }, targets);\r\n    }\r\n\r\n    // =============================================================================\r\n    // Processing Methods\r\n    // =============================================================================\r\n\r\n    /**\r\n     * Process a remote knowledge check\r\n     */\r\n    private processRemoteKnowledgeCheck(actorId: string, checkType: string, result: any): void {\r\n        // Handle the knowledge check result from another player\r\n        // This might update UI, show notifications, or trigger other effects\r\n\r\n        const actor = game.actors.get(actorId);\r\n        if (!actor) {\r\n            console.warn(`${MODULE_ID} | Actor not found for knowledge check: ${actorId}`);\r\n            return;\r\n        }\r\n\r\n        // Show notification or update UI based on the result\r\n        ui.notifications.info(`Knowledge check performed on ${actor.name} by another player`);\r\n    }\r\n\r\n    /**\r\n     * Display shared knowledge to the user\r\n     */\r\n    private displaySharedKnowledge(knowledge: any, targetActorId: string): void {\r\n        // Display the shared knowledge information\r\n        // This might create a chat message or show a dialog\r\n\r\n        const actor = game.actors.get(targetActorId);\r\n        if (!actor) {\r\n            return;\r\n        }\r\n\r\n        // Create a chat message with the shared knowledge\r\n        // (Implementation would depend on the knowledge format)\r\n    }\r\n\r\n    /**\r\n     * Update local rules based on remote changes\r\n     */\r\n    private updateLocalRules(ruleElement: any, action: 'add' | 'remove' | 'update'): void {\r\n        // Update the local rules engine based on changes from other clients\r\n        // This ensures all clients stay synchronized\r\n\r\n        switch (action) {\r\n            case 'add':\r\n                // Add the rule element locally\r\n                break;\r\n            case 'remove':\r\n                // Remove the rule element locally\r\n                break;\r\n            case 'update':\r\n                // Update the existing rule element\r\n                break;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Synchronize data with remote clients\r\n     */\r\n    private synchronizeData(dataType: string, syncData: any): void {\r\n        // Handle different types of data synchronization\r\n\r\n        switch (dataType) {\r\n            case 'rules':\r\n                // Synchronize rule elements\r\n                break;\r\n            case 'knowledge':\r\n                // Synchronize knowledge data\r\n                break;\r\n            case 'settings':\r\n                // Synchronize module settings\r\n                break;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Check if user has permission for socket operations\r\n     */\r\n    private hasPermission(operation: string): boolean {\r\n        // Check user permissions for specific operations\r\n        // This might depend on GM status, module settings, etc.\r\n\r\n        switch (operation) {\r\n            case 'shareKnowledge':\r\n                return true; // All users can share knowledge\r\n            case 'updateRules':\r\n                return game.user.isGM; // Only GMs can update rules\r\n            default:\r\n                return false;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Handle GM approval request messages\r\n     */\r\n    private handleGMApprovalRequest(message: SocketMessage): void {\r\n        if (!game.user.isGM) return;\r\n\r\n        const recallKnowledgeManager = (globalThis as any).RecallKnowledge?.module?.recallKnowledgeManager;\r\n        if (recallKnowledgeManager) {\r\n            recallKnowledgeManager.showGMApprovalDialog(message.data);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Handle recall knowledge result messages\r\n     */\r\n    private handleRecallKnowledgeResult(message: SocketMessage): void {\r\n        const { result } = message.data;\r\n\r\n        // Show result to player\r\n        if (result.success) {\r\n            ui.notifications.info(`Recall Knowledge ${result.degree}: You learned something!`);\r\n        } else {\r\n            ui.notifications.warn(`Recall Knowledge ${result.degree}: You couldn't recall anything useful.`);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Handle recall knowledge denied messages\r\n     */\r\n    private handleRecallKnowledgeDenied(message: SocketMessage): void {\r\n        const { reason } = message.data;\r\n        ui.notifications.warn(`Recall Knowledge request denied: ${reason || 'GM denied the request'}`);\r\n    }\r\n}","/**\r\n * Recall Knowledge - FoundryVTT Module\r\n * A comprehensive module for enhanced rules engine functionality and knowledge management\r\n */\r\n\r\nimport { MODULE_ID, MODULE_TITLE } from './constants';\r\nimport {\r\n    HookManager,\r\n    ModuleAPI,\r\n    RecallKnowledgeManager,\r\n    RecallKnowledgeSettings,\r\n    RulesEngine,\r\n    SocketHandler\r\n} from './modules';\r\n\r\n/**\r\n * Main module initialization class\r\n */\r\nclass RecallKnowledgeModule {\r\n    private static instance: RecallKnowledgeModule;\r\n\r\n    private settings!: RecallKnowledgeSettings;\r\n    private rulesEngine!: RulesEngine;\r\n    private hookManager!: HookManager;\r\n    private socketHandler!: SocketHandler;\r\n    private api!: ModuleAPI;\r\n    private recallKnowledgeManager!: RecallKnowledgeManager;\r\n\r\n    constructor() {\r\n        if (RecallKnowledgeModule.instance) {\r\n            return RecallKnowledgeModule.instance;\r\n        }\r\n\r\n        RecallKnowledgeModule.instance = this;\r\n\r\n        this.settings = new RecallKnowledgeSettings();\r\n        this.rulesEngine = new RulesEngine();\r\n        this.hookManager = new HookManager();\r\n        this.socketHandler = new SocketHandler();\r\n        this.api = new ModuleAPI();\r\n        this.recallKnowledgeManager = new RecallKnowledgeManager();\r\n    }\r\n\r\n    /**\r\n     * Initialize the module\r\n     */\r\n    public async initialize(): Promise<void> {\r\n        console.log(`${MODULE_TITLE} | Initializing module...`);\r\n\r\n        try {\r\n            // Register module settings\r\n            await this.settings.register();\r\n\r\n            // Initialize rules engine\r\n            await this.rulesEngine.initialize();\r\n\r\n            // Setup hooks\r\n            this.hookManager.setupHooks();\r\n\r\n            // Initialize socket handling\r\n            this.socketHandler.initialize();\r\n\r\n            // Setup API with component references\r\n            this.api.setComponents(this.rulesEngine, this.socketHandler, this.settings);\r\n            this.api.setupAPI();\r\n\r\n            console.log(`${MODULE_TITLE} | Module initialized successfully`);\r\n        } catch (error) {\r\n            console.error(`${MODULE_TITLE} | Error during initialization:`, error);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Get the module instance\r\n     */\r\n    public static getInstance(): RecallKnowledgeModule {\r\n        if (!RecallKnowledgeModule.instance) {\r\n            RecallKnowledgeModule.instance = new RecallKnowledgeModule();\r\n        }\r\n        return RecallKnowledgeModule.instance;\r\n    }\r\n\r\n    /**\r\n     * Get the recall knowledge manager\r\n     */\r\n    public getRecallKnowledgeManager(): RecallKnowledgeManager {\r\n        return this.recallKnowledgeManager;\r\n    }\r\n}\r\n\r\n// Initialize the module when Foundry is ready\r\nHooks.once('init', async () => {\r\n    const module = RecallKnowledgeModule.getInstance();\r\n    await module.initialize();\r\n});\r\n\r\n// Setup module for ready hook\r\nHooks.once('ready', () => {\r\n    console.log(`${MODULE_TITLE} | Module ready`);\r\n\r\n    const moduleInstance = RecallKnowledgeModule.getInstance();\r\n\r\n    // Make the module globally available for debugging and API access\r\n    (globalThis as any).RecallKnowledge = {\r\n        module: moduleInstance,\r\n        recallKnowledgeManager: moduleInstance.getRecallKnowledgeManager(),\r\n        MODULE_ID,\r\n        MODULE_TITLE,\r\n    };\r\n});"],"names":[],"mappings":"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"}